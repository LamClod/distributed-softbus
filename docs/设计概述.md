# 分布式软总线系统设计稿

## 项目概述

本项目实现一个基于虚拟总线模型的分布式设备互联框架，旨在为多设备协同提供透明、高效、安全的通信基础设施。

### 核心目标

1. **位置透明性**：应用程序无需感知服务具体位于本地还是远程设备
2. **传输无关性**：框架自动选择并管理最优的底层网络链路
3. **协议统一性**：为上层应用提供标准化的服务发现与RPC接口

### 技术栈选型

#### 主框架层（Rust）
- **核心引擎**：Rust实现，提供内存安全、并发安全和零成本抽象
- **优势**：
  - 无GC，性能可预测
  - 强类型系统保证线程安全
  - 优秀的跨平台支持
  - 丰富的异步生态（tokio）

#### 平台适配层
- **Windows平台**：C#/.NET（蓝牙、Wi-Fi Direct API封装）
- **Linux/嵌入式**：C/C++（BlueZ、NetworkManager等）
- **跨平台桥接**：通过FFI（Foreign Function Interface）与Rust核心通信

#### 关键依赖库
```toml
# Rust核心依赖
tokio = "1.35"          # 异步运行时
serde = "1.0"           # 序列化框架
tonic = "0.11"          # gRPC实现
btleplug = "0.11"       # 跨平台BLE库
mdns-sd = "0.7"         # mDNS服务发现
ring = "0.17"           # 加密库
protobuf = "3.3"        # 协议缓冲区
dashmap = "5.5"         # 并发HashMap
```

## 系统架构分层

```
┌─────────────────────────────────────────────────┐
│           应用层 (Application Layer)             │
│  开发者通过IDL生成的Proxy/Stub进行服务调用        │
└─────────────────────────────────────────────────┘
                      ▲
                      │ 标准API
                      ▼
┌─────────────────────────────────────────────────┐
│      Proxy-Stub层 (IDL编译器自动生成)            │
│  - ServiceProxy (调用端代理)                     │
│  - ServiceStub (服务端桩)                        │
└─────────────────────────────────────────────────┘
                      ▲
                      │ RPC接口
                      ▼
┌─────────────────────────────────────────────────┐
│            核心层 (Core Layer) - Rust            │
│  ┌─────────────┬──────────────┬───────────────┐ │
│  │ 连接管理器   │  服务路由器   │  安全认证模块  │ │
│  └─────────────┴──────────────┴───────────────┘ │
│  ┌─────────────────────────────────────────────┐ │
│  │        传输仲裁器 (Transport Arbiter)       │ │
│  │   动态选择最优链路（BLE、Wi-Fi P2P等）      │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
                      ▲
                      │ 统一接口
                      ▼
┌─────────────────────────────────────────────────┐
│      网络抽象层 (Network Abstraction Layer)      │
│  ┌──────────┬────────────┬──────────────────┐  │
│  │ BLE适配器 │ WiFi适配器  │  mDNS适配器     │  │
│  │  (Rust)  │ (C#/C++)   │   (Rust)        │  │
│  └──────────┴────────────┴──────────────────┘  │
└─────────────────────────────────────────────────┘
                      ▲
                      │ FFI调用
                      ▼
┌─────────────────────────────────────────────────┐
│         平台原生层 (Platform Native)             │
│  Windows: C# WinRT APIs / Linux: C/C++ BlueZ    │
└─────────────────────────────────────────────────┘
```

## 核心模块概览

### 1. 设备发现与组网模块（Discovery & Networking）
**语言**：Rust + C#/C++适配器
**职责**：
- 多协议设备发现（BLE广播、mDNS）
- 自动建立虚拟通道
- 连接池管理

### 2. 服务注册与发现模块（Service Registry）
**语言**：纯Rust实现
**职责**：
- 分布式服务路由表维护
- 服务发布/订阅机制
- 服务能力协商

### 3. RPC引擎（Remote Procedure Call）
**语言**：Rust + Protobuf
**职责**：
- 请求序列化/反序列化
- 调用路由与转发
- 超时与重试机制

### 4. 传输仲裁器（Transport Arbiter）
**语言**：纯Rust实现
**职责**：
- 实时链路质量评估
- 动态切换传输介质
- QoS保证

### 5. 安全认证模块（Security & Auth）
**语言**：Rust（使用ring库）
**职责**：
- 设备身份验证
- 端到端加密（TLS 1.3）
- 权限控制

### 6. IDL编译器（Interface Definition Compiler）
**语言**：Rust
**职责**：
- 解析服务接口定义
- 生成Proxy/Stub代码
- 支持多语言绑定

## 关键设计决策

### 1. 为什么选择Rust作为核心语言？
- **内存安全**：编译期消除数据竞争，避免空指针和缓冲区溢出
- **零成本抽象**：性能接近C++，无运行时开销
- **并发友好**：`async/await`语法天然适合网络编程
- **生态成熟**：tokio、serde等库提供工业级支持

### 2. 为什么底层使用C#和C/C++？
- **平台API封装**：
  - Windows的蓝牙和Wi-Fi Direct API主要是C# WinRT封装
  - Linux的BlueZ、NetworkManager是C/C++ API
- **避免重复造轮**：直接利用平台成熟的驱动和协议栈
- **FFI桥接成本可控**：Rust的FFI机制成熟，性能损耗小于1%

### 3. 虚拟通道设计
```rust
// 虚拟通道抽象（屏蔽底层传输差异）
pub trait VirtualChannel: Send + Sync {
    async fn send(&self, data: &[u8]) -> Result<usize>;
    async fn recv(&self, buf: &mut [u8]) -> Result<usize>;
    fn quality(&self) -> LinkQuality;  // RSSI、延迟、带宽
    fn transport_type(&self) -> TransportType;  // BLE/WiFi/Ethernet
}

// 多链路聚合（同时使用BLE保活 + Wi-Fi传输数据）
pub struct AggregatedChannel {
    control_link: Box<dyn VirtualChannel>,  // BLE用于控制
    data_link: Box<dyn VirtualChannel>,     // Wi-Fi用于数据
}
```

## 开发路线图

### Phase 1: 基础框架（4周）
- [x] 项目结构搭建
- [ ] 网络抽象层接口定义
- [ ] BLE适配器实现（Rust + C#）
- [ ] 基础连接管理器

### Phase 2: 服务发现（3周）
- [ ] mDNS服务发现
- [ ] 服务注册表实现
- [ ] 分布式路由算法

### Phase 3: RPC引擎（4周）
- [ ] IDL语法设计
- [ ] Protobuf集成
- [ ] Proxy/Stub代码生成器
- [ ] 异步调用框架

### Phase 4: 高级特性（5周）
- [ ] 传输仲裁器
- [ ] 安全认证模块
- [ ] 服务质量保证
- [ ] 故障恢复机制

### Phase 5: 测试与优化（4周）
- [ ] 单元测试覆盖
- [ ] 性能基准测试
- [ ] 多设备集成测试
- [ ] 文档完善

## 性能指标

### 目标指标
| 指标 | 目标值 | 说明 |
|------|--------|------|
| 设备发现延迟 | < 500ms | BLE广播周期优化 |
| RPC调用延迟 | < 50ms | 局域网Wi-Fi环境 |
| 链路切换时间 | < 200ms | BLE → Wi-Fi升级 |
| 内存占用 | < 50MB | 支持10个并发连接 |
| CPU占用 | < 5% | 空闲状态 |

### 测试场景
1. **手机-平板协同**：手机拍照，平板实时编辑
2. **智能手表控制**：手表控制手机音乐播放
3. **多设备文件共享**：3台设备间文件同步

## 下一步行动

请参阅以下详细设计文档：
1. `架构设计.md` - 详细的模块设计与接口定义
2. `实施指南.md` - 技术实现细节与代码示例
3. `API文档.md` - 开发者API参考
4. `部署指南.md` - 编译、部署与配置说明
