# é¡¹ç›®ç»“æ„è¯´æ˜

## å®Œæ•´ç›®å½•æ ‘

```
distributed-softbus/
â”œâ”€â”€ Cargo.toml                    # Workspaceæ ¹é…ç½®
â”œâ”€â”€ README.md                     # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ LICENSE                       # è®¸å¯è¯
â”œâ”€â”€ .gitignore                    # Gitå¿½ç•¥æ–‡ä»¶
â”‚
â”œâ”€â”€ softbus-core/                 # æ ¸å¿ƒåº“ï¼ˆRustï¼‰
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ build.rs                  # æ„å»ºè„šæœ¬ï¼ˆProtobufç¼–è¯‘ï¼‰
â”‚   â”œâ”€â”€ proto/
â”‚   â”‚   â”œâ”€â”€ rpc.proto             # RPCåè®®å®šä¹‰
â”‚   â”‚   â””â”€â”€ service.proto         # æœåŠ¡å‘ç°åè®®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs                # åº“å…¥å£
â”‚   â”‚   â”œâ”€â”€ error.rs              # é”™è¯¯å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ types.rs              # å…¬å…±ç±»å‹
â”‚   â”‚   â”œâ”€â”€ channel.rs            # è™šæ‹Ÿé€šé“trait
â”‚   â”‚   â”œâ”€â”€ connection/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ manager.rs        # è¿æ¥ç®¡ç†å™¨
â”‚   â”‚   â”‚   â””â”€â”€ pool.rs           # è¿æ¥æ± 
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ registry.rs       # æœåŠ¡æ³¨å†Œè¡¨
â”‚   â”‚   â”‚   â””â”€â”€ router.rs         # æœåŠ¡è·¯ç”±å™¨
â”‚   â”‚   â”œâ”€â”€ rpc/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ client.rs         # RPCå®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â””â”€â”€ server.rs         # RPCæœåŠ¡ç«¯
â”‚   â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.rs           # èº«ä»½è®¤è¯
â”‚   â”‚   â”‚   â””â”€â”€ crypto.rs         # åŠ å¯†æ¨¡å—
â”‚   â”‚   â””â”€â”€ arbiter/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â””â”€â”€ transport.rs      # ä¼ è¾“ä»²è£å™¨
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ integration_test.rs   # é›†æˆæµ‹è¯•
â”‚       â””â”€â”€ bench.rs              # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚
â”œâ”€â”€ softbus-network/              # ç½‘ç»œæŠ½è±¡å±‚ï¼ˆRust + FFIï¼‰
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs
â”‚   â”‚   â”œâ”€â”€ adapter.rs            # ç½‘ç»œé€‚é…å™¨trait
â”‚   â”‚   â”œâ”€â”€ ble/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ adapter.rs        # BLEé€‚é…å™¨
â”‚   â”‚   â”‚   â””â”€â”€ channel.rs        # BLEè™šæ‹Ÿé€šé“
â”‚   â”‚   â”œâ”€â”€ wifi/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ ffi.rs            # C/C++ FFIç»‘å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ adapter.rs        # Wi-Fi Directé€‚é…å™¨
â”‚   â”‚   â”‚   â””â”€â”€ channel.rs
â”‚   â”‚   â””â”€â”€ mdns/
â”‚   â”‚       â”œâ”€â”€ mod.rs
â”‚   â”‚       â””â”€â”€ adapter.rs        # mDNSé€‚é…å™¨
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ ble_test.rs
â”‚
â”œâ”€â”€ softbus-idl-compiler/         # IDLç¼–è¯‘å™¨ï¼ˆRustï¼‰
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs               # ç¼–è¯‘å™¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ lexer.rs          # è¯æ³•åˆ†æ
â”‚   â”‚   â”‚   â””â”€â”€ ast.rs            # æŠ½è±¡è¯­æ³•æ ‘
â”‚   â”‚   â”œâ”€â”€ codegen/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ rust.rs           # Rustä»£ç ç”Ÿæˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ csharp.rs         # C#ä»£ç ç”Ÿæˆ
â”‚   â”‚   â”‚   â””â”€â”€ cpp.rs            # C++ä»£ç ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ templates/            # ä»£ç æ¨¡æ¿
â”‚   â”‚       â”œâ”€â”€ proxy.rs.hbs
â”‚   â”‚       â””â”€â”€ stub.rs.hbs
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ codegen_test.rs
â”‚
â”œâ”€â”€ native/                       # åŸç”Ÿå¹³å°ä»£ç 
â”‚   â”œâ”€â”€ windows/                  # Windowså¹³å°ï¼ˆC#ï¼‰
â”‚   â”‚   â”œâ”€â”€ SoftBus.Native.csproj
â”‚   â”‚   â”œâ”€â”€ BleAdapter.cs         # BLEé€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ WiFiDirectAdapter.cs  # Wi-Fi Directé€‚é…å™¨
â”‚   â”‚   â””â”€â”€ build.ps1
â”‚   â”œâ”€â”€ linux/                    # Linuxå¹³å°ï¼ˆC/C++ï¼‰
â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”‚   â”œâ”€â”€ wifi_direct.h
â”‚   â”‚   â”‚   â””â”€â”€ ble_adapter.h
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ wifi_direct.cpp
â”‚   â”‚   â”‚   â””â”€â”€ ble_adapter.cpp
â”‚   â”‚   â””â”€â”€ build.sh
â”‚   â””â”€â”€ android/                  # Androidå¹³å°ï¼ˆJNIï¼‰
â”‚       â”œâ”€â”€ build.gradle
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ com/softbus/
â”‚               â””â”€â”€ NativeAdapter.java
â”‚
â”œâ”€â”€ examples/                     # ç¤ºä¾‹åº”ç”¨
â”‚   â”œâ”€â”€ camera-service/           # åˆ†å¸ƒå¼ç›¸æœºæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â”œâ”€â”€ camera_service.idl    # æœåŠ¡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ server.rs         # æœåŠ¡ç«¯
â”‚   â”‚   â”‚   â””â”€â”€ client.rs         # å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ generated/            # IDLç”Ÿæˆä»£ç 
â”‚   â”œâ”€â”€ file-transfer/            # æ–‡ä»¶ä¼ è¾“
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ main.rs
â”‚   â”œâ”€â”€ remote-control/           # è¿œç¨‹æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ main.rs
â”‚   â””â”€â”€ bench/                    # æ€§èƒ½æµ‹è¯•
â”‚       â”œâ”€â”€ latency.rs
â”‚       â””â”€â”€ throughput.rs
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£
â”‚   â”œâ”€â”€ è®¾è®¡æ¦‚è¿°.md
â”‚   â”œâ”€â”€ æ¶æ„è®¾è®¡.md
â”‚   â”œâ”€â”€ å®æ–½æŒ‡å—.md
â”‚   â”œâ”€â”€ APIå‚è€ƒ.md
â”‚   â””â”€â”€ FAQ.md
â”‚
â””â”€â”€ scripts/                      # æ„å»ºè„šæœ¬
    â”œâ”€â”€ build-all.sh              # æ„å»ºæ‰€æœ‰å¹³å°
    â”œâ”€â”€ run-tests.sh              # è¿è¡Œæµ‹è¯•
    â””â”€â”€ install-deps.sh           # å®‰è£…ä¾èµ–
```

## æ¨¡å—ä¾èµ–å…³ç³»

```
softbus-examples
    â†“ depends on
softbus-core
    â†“ depends on
softbus-network
    â†“ FFI calls
native (C#/C++)
```

## é…ç½®æ–‡ä»¶è¯¦è§£

### 1. æ ¹Cargo.toml

```toml
[workspace]
members = [
    "softbus-core",
    "softbus-network",
    "softbus-idl-compiler",
    "examples/camera-service",
    "examples/file-transfer",
    "examples/remote-control",
]

resolver = "2"

[workspace.package]
version = "0.1.0"
edition = "2021"
license = "MIT OR Apache-2.0"
authors = ["Your Team <team@example.com>"]
repository = "https://github.com/yourorg/distributed-softbus"

[workspace.dependencies]
# å¼‚æ­¥è¿è¡Œæ—¶
tokio = { version = "1.35", features = ["full"] }
async-trait = "0.1"

# åºåˆ—åŒ–
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
bincode = "1.3"
prost = "0.12"
prost-build = "0.12"

# gRPCï¼ˆå¯é€‰ï¼‰
tonic = { version = "0.11", optional = true }
tonic-build = { version = "0.11", optional = true }

# å¹¶å‘æ•°æ®ç»“æ„
dashmap = "5.5"
parking_lot = "0.12"

# ç½‘ç»œ
bytes = "1.5"
socket2 = "0.5"

# åŠ å¯†
ring = "0.17"
rustls = "0.22"
rustls-pemfile = "2.0"

# æ—¥å¿—
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

# é”™è¯¯å¤„ç†
thiserror = "1.0"
anyhow = "1.0"

# å·¥å…·
uuid = { version = "1.6", features = ["v4"] }
chrono = "0.4"
hex = "0.4"

# BLE
btleplug = "0.11"

# mDNS
mdns-sd = "0.7"

# Windowsç‰¹å®š
[target.'cfg(windows)'.dependencies]
windows = { version = "0.52", features = [
    "Devices_Bluetooth",
    "Devices_Bluetooth_Advertisement",
    "Devices_Bluetooth_GenericAttributeProfile",
] }

# Unixç‰¹å®š
[target.'cfg(unix)'.dependencies]
nix = { version = "0.27", features = ["net"] }
libc = "0.2"

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true

[profile.dev]
opt-level = 0
debug = true
```

### 2. softbus-core/Cargo.toml

```toml
[package]
name = "softbus-core"
version.workspace = true
edition.workspace = true
license.workspace = true
authors.workspace = true

[dependencies]
# Workspaceä¾èµ–
tokio.workspace = true
async-trait.workspace = true
serde.workspace = true
serde_json.workspace = true
bincode.workspace = true
prost.workspace = true
dashmap.workspace = true
parking_lot.workspace = true
bytes.workspace = true
ring.workspace = true
rustls.workspace = true
tracing.workspace = true
thiserror.workspace = true
anyhow.workspace = true
uuid.workspace = true
chrono.workspace = true

# æœ¬åœ°ä¾èµ–
softbus-network = { path = "../softbus-network" }

[build-dependencies]
prost-build.workspace = true

[dev-dependencies]
tokio-test = "0.4"
criterion = "0.5"

[[bench]]
name = "rpc_bench"
harness = false
```

### 3. build.rsï¼ˆProtobufç¼–è¯‘ï¼‰

```rust
// softbus-core/build.rs

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // ç¼–è¯‘Protobufæ–‡ä»¶
    let proto_files = &[
        "proto/rpc.proto",
        "proto/service.proto",
    ];
    
    let proto_include = &["proto"];
    
    prost_build::Config::new()
        .out_dir("src/generated")
        .compile_protos(proto_files, proto_include)?;
    
    // é‡æ–°ç¼–è¯‘è§¦å‘æ¡ä»¶
    for file in proto_files {
        println!("cargo:rerun-if-changed={}", file);
    }
    
    Ok(())
}
```

### 4. .gitignore

```gitignore
# Rust
/target
**/*.rs.bk
Cargo.lock

# IDLç”Ÿæˆä»£ç 
**/generated/

# åŸç”Ÿæ„å»ºäº§ç‰©
native/windows/bin/
native/windows/obj/
native/linux/build/
native/android/build/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# æµ‹è¯•è¾“å‡º
*.pcap
*.log
```

### 5. README.md

```markdown
# åˆ†å¸ƒå¼è½¯æ€»çº¿ (Distributed Soft-Bus)

ä¸€ä¸ªåŸºäºè™šæ‹Ÿæ€»çº¿æ¨¡å‹çš„è·¨è®¾å¤‡é€šä¿¡æ¡†æ¶ï¼Œå®ç°é€æ˜çš„åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨ã€‚

## ç‰¹æ€§

- ğŸ”Œ **ä½ç½®é€æ˜**: åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡
- ğŸŒ **å¤šåè®®æ”¯æŒ**: BLEã€Wi-Fi Directã€mDNSè‡ªåŠ¨åˆ‡æ¢
- ğŸ” **å®‰å…¨è®¤è¯**: ç«¯åˆ°ç«¯åŠ å¯†ï¼Œè®¾å¤‡èº«ä»½éªŒè¯
- âš¡ **é«˜æ€§èƒ½**: é›¶æ‹·è´ä¼ è¾“ï¼Œè¿æ¥æ± å¤ç”¨
- ğŸ¦€ **å†…å­˜å®‰å…¨**: Rustå®ç°ï¼Œæ— æ•°æ®ç«äº‰

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
# Rustå·¥å…·é“¾
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# å¹³å°ä¾èµ–ï¼ˆLinuxï¼‰
sudo apt install build-essential libbluetooth-dev
```

### æ„å»ºé¡¹ç›®

```bash
git clone https://github.com/yourorg/distributed-softbus
cd distributed-softbus
cargo build --workspace --release
```

### è¿è¡Œç¤ºä¾‹

```bash
# ç»ˆç«¯1ï¼šå¯åŠ¨ç›¸æœºæœåŠ¡
cargo run --example camera-server

# ç»ˆç«¯2ï¼šè°ƒç”¨ç›¸æœºæœåŠ¡
cargo run --example camera-client
```

## æ¶æ„æ¦‚è§ˆ

è¯¦è§ [docs/æ¶æ„è®¾è®¡.md](docs/æ¶æ„è®¾è®¡.md)

## å¼€å‘æŒ‡å—

å‚è§ [docs/å®æ–½æŒ‡å—.md](docs/å®æ–½æŒ‡å—.md)

## è®¸å¯è¯

MIT OR Apache-2.0
```

### 6. Justfileï¼ˆä»»åŠ¡è‡ªåŠ¨åŒ–ï¼‰

```justfile
# ä½¿ç”¨ just å‘½ä»¤è¿è¡Œä»»åŠ¡

# é»˜è®¤ä»»åŠ¡ï¼šæ˜¾ç¤ºå¸®åŠ©
default:
    @just --list

# æ„å»ºæ‰€æœ‰æ¨¡å—
build:
    cargo build --workspace

# æ„å»ºReleaseç‰ˆæœ¬
build-release:
    cargo build --workspace --release

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
    cargo test --workspace

# è¿è¡Œå•ä¸ªæ¨¡å—æµ‹è¯•
test-core:
    cargo test -p softbus-core

# ä»£ç æ ¼å¼åŒ–
fmt:
    cargo fmt --all

# ä»£ç æ£€æŸ¥
check:
    cargo clippy --workspace -- -D warnings

# ç”Ÿæˆæ–‡æ¡£
docs:
    cargo doc --workspace --no-deps --open

# è¿è¡Œç›¸æœºæœåŠ¡ç¤ºä¾‹
run-camera-server:
    cargo run --example camera-server

# è¿è¡Œç›¸æœºå®¢æˆ·ç«¯
run-camera-client:
    cargo run --example camera-client

# æ€§èƒ½æµ‹è¯•
bench:
    cargo bench --workspace

# æ¸…ç†æ„å»ºäº§ç‰©
clean:
    cargo clean
    rm -rf native/linux/build
    rm -rf native/windows/bin

# å®‰è£…IDLç¼–è¯‘å™¨
install-idl-compiler:
    cargo install --path softbus-idl-compiler

# ç¼–è¯‘IDLæ–‡ä»¶
compile-idl file:
    softbus-idl-compiler {{file}} --output generated/

# äº¤å‰ç¼–è¯‘åˆ°Android
build-android:
    cargo build --target aarch64-linux-android --release

# è¿è¡Œå®Œæ•´CIæµç¨‹
ci: fmt check test build-release
```

### 7. GitHub Actions CIé…ç½®

```yaml
# .github/workflows/ci.yml

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, nightly]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        override: true
    
    - name: Install Linux dependencies
      if: runner.os == 'Linux'
      run: sudo apt-get install -y libbluetooth-dev
    
    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build
      run: cargo build --workspace --verbose
    
    - name: Run tests
      run: cargo test --workspace --verbose
    
    - name: Run clippy
      run: cargo clippy --workspace -- -D warnings

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin
    
    - name: Generate coverage
      run: cargo tarpaulin --workspace --out Xml
    
    - name: Upload to codecov
      uses: codecov/codecov-action@v3
```

## å¼€å‘å·¥ä½œæµ

### 1. æ·»åŠ æ–°åŠŸèƒ½

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/new-transport

# å¼€å‘å¹¶æµ‹è¯•
cargo watch -x 'test -p softbus-network'

# æäº¤ä»£ç 
git add .
git commit -m "feat: add USB transport adapter"
git push origin feature/new-transport
```

### 2. è°ƒè¯•æŠ€å·§

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
RUST_LOG=softbus=trace cargo run --example camera-server

# ä½¿ç”¨lldbè°ƒè¯•
rust-lldb target/debug/examples/camera-server

# æ€§èƒ½åˆ†æ
cargo flamegraph --example camera-server
```

### 3. å‘å¸ƒæ–°ç‰ˆæœ¬

```bash
# æ›´æ–°ç‰ˆæœ¬å·
cargo set-version 0.2.0

# æ„å»ºå¹¶æµ‹è¯•
just ci

# å‘å¸ƒåˆ°crates.io
cargo publish -p softbus-core
cargo publish -p softbus-network
```

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®ç°æ ¸å¿ƒæ¨¡å—ï¼Œå‚è§å„å­æ¨¡å—çš„READMEã€‚
