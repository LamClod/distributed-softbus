# 部署指南

## 生产环境部署

### 1. 系统要求

#### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 2核 | 4核+ |
| 内存 | 2GB | 4GB+ |
| 存储 | 100MB | 500MB+ |
| 蓝牙 | BLE 4.0 | BLE 5.0+ |
| Wi-Fi | 802.11n | 802.11ac+ |

#### 软件要求

- **操作系统**: 
  - Linux: Ubuntu 20.04+, Debian 11+, CentOS 8+
  - Windows: Windows 10 1809+, Windows Server 2019+
  - macOS: 11.0+
- **Rust**: 1.75+（编译时）
- **BlueZ**: 5.50+（Linux）
- **systemd**: 240+（可选，用于服务管理）

---

## Linux生产部署

### 1. 编译优化版本

```bash
# 使用发布配置编译
RUSTFLAGS="-C target-cpu=native" cargo build --release

# 剥离调试符号（减小体积）
strip target/release/softbus-daemon

# 验证二进制
ldd target/release/softbus-daemon
file target/release/softbus-daemon
```

### 2. 创建系统用户

```bash
# 创建专用用户
sudo useradd -r -s /bin/false -d /var/lib/softbus softbus

# 添加到必要的组
sudo usermod -a -G bluetooth softbus
sudo usermod -a -G netdev softbus
```

### 3. 安装文件

```bash
# 创建目录结构
sudo mkdir -p /opt/softbus/bin
sudo mkdir -p /etc/softbus
sudo mkdir -p /var/lib/softbus
sudo mkdir -p /var/log/softbus

# 复制二进制文件
sudo cp target/release/softbus-daemon /opt/softbus/bin/
sudo chmod 755 /opt/softbus/bin/softbus-daemon

# 复制配置文件
sudo cp config/production.toml /etc/softbus/config.toml
sudo chmod 644 /etc/softbus/config.toml

# 设置权限
sudo chown -R softbus:softbus /var/lib/softbus
sudo chown -R softbus:softbus /var/log/softbus
```

### 4. 配置文件

```toml
# /etc/softbus/config.toml

[device]
name = "ProductionDevice"
type = "Server"

[network]
enabled_adapters = ["ble", "mdns", "ethernet"]

[network.ble]
advertising_interval_ms = 1000
scan_window_ms = 30
connection_timeout_secs = 30

[security]
enable_authentication = true
enable_encryption = true
cert_path = "/etc/softbus/certs/device.crt"
key_path = "/etc/softbus/certs/device.key"
trusted_devices_path = "/etc/softbus/trusted_devices.json"

[performance]
connection_pool_size = 20
rpc_timeout_secs = 30
max_retries = 3
buffer_size = 65536

[logging]
level = "info"
output = "file"
file_path = "/var/log/softbus/softbus.log"
max_size_mb = 100
max_backups = 10
```

### 5. Systemd服务配置

```ini
# /etc/systemd/system/softbus.service

[Unit]
Description=Distributed Soft-Bus Daemon
Documentation=https://docs.softbus.io
After=network.target bluetooth.target
Wants=bluetooth.target

[Service]
Type=notify
User=softbus
Group=softbus

# 主进程
ExecStart=/opt/softbus/bin/softbus-daemon --config /etc/softbus/config.toml

# 环境变量
Environment="RUST_LOG=info"
Environment="RUST_BACKTRACE=1"

# 工作目录
WorkingDirectory=/var/lib/softbus

# 资源限制
LimitNOFILE=65536
LimitNPROC=4096

# 安全加固
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/softbus /var/log/softbus

# 能力
AmbientCapabilities=CAP_NET_RAW CAP_NET_ADMIN CAP_NET_BIND_SERVICE

# 重启策略
Restart=on-failure
RestartSec=5s
StartLimitInterval=60s
StartLimitBurst=3

[Install]
WantedBy=multi-user.target
```

### 6. 启动服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用自动启动
sudo systemctl enable softbus

# 启动服务
sudo systemctl start softbus

# 检查状态
sudo systemctl status softbus

# 查看日志
sudo journalctl -u softbus -f
```

---

## Windows生产部署

### 1. 编译

```powershell
# 使用发布配置
$env:RUSTFLAGS="-C target-cpu=native"
cargo build --release

# 验证依赖
dumpbin /dependents target\release\softbus-daemon.exe
```

### 2. 安装为Windows服务

```powershell
# 使用sc命令创建服务
sc.exe create SoftBusService `
    binPath= "C:\Program Files\SoftBus\softbus-daemon.exe --config C:\ProgramData\SoftBus\config.toml" `
    DisplayName= "Distributed Soft-Bus Service" `
    start= auto

# 配置服务描述
sc.exe description SoftBusService "Distributed device interconnection framework"

# 配置失败恢复
sc.exe failure SoftBusService reset= 86400 actions= restart/5000/restart/10000/restart/30000

# 启动服务
sc.exe start SoftBusService
```

### 3. 使用NSSM（推荐）

```powershell
# 下载NSSM
Invoke-WebRequest -Uri https://nssm.cc/release/nssm-2.24.zip -OutFile nssm.zip
Expand-Archive nssm.zip

# 安装服务
.\nssm.exe install SoftBusService "C:\Program Files\SoftBus\softbus-daemon.exe"
.\nssm.exe set SoftBusService AppDirectory "C:\ProgramData\SoftBus"
.\nssm.exe set SoftBusService AppParameters "--config C:\ProgramData\SoftBus\config.toml"
.\nssm.exe set SoftBusService DisplayName "Distributed Soft-Bus Service"
.\nssm.exe set SoftBusService Description "Device interconnection framework"
.\nssm.exe set SoftBusService Start SERVICE_AUTO_START

# 配置日志
.\nssm.exe set SoftBusService AppStdout "C:\ProgramData\SoftBus\logs\stdout.log"
.\nssm.exe set SoftBusService AppStderr "C:\ProgramData\SoftBus\logs\stderr.log"

# 启动
.\nssm.exe start SoftBusService
```

---

## Docker部署

### 1. Dockerfile（多阶段构建）

```dockerfile
# 构建阶段
FROM rust:1.75-slim as builder

# 安装依赖
RUN apt-get update && apt-get install -y \
    pkg-config \
    libbluetooth-dev \
    libdbus-1-dev \
    cmake \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# 复制依赖清单（利用Docker缓存）
COPY Cargo.toml Cargo.lock ./
COPY softbus-core/Cargo.toml softbus-core/
COPY softbus-network/Cargo.toml softbus-network/
COPY softbus-idl-compiler/Cargo.toml softbus-idl-compiler/

# 创建虚拟项目以缓存依赖
RUN mkdir -p softbus-core/src softbus-network/src softbus-idl-compiler/src && \
    echo "fn main() {}" > softbus-core/src/lib.rs && \
    echo "fn main() {}" > softbus-network/src/lib.rs && \
    echo "fn main() {}" > softbus-idl-compiler/src/main.rs && \
    cargo build --release && \
    rm -rf softbus-*/src

# 复制实际源码
COPY . .

# 清理虚拟构建产物并重新编译
RUN touch softbus-*/src/* && \
    cargo build --release

# 运行时阶段
FROM debian:bookworm-slim

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    bluetooth \
    bluez \
    libdbus-1-3 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# 创建用户
RUN useradd -r -s /bin/false -d /var/lib/softbus softbus

# 复制二进制
COPY --from=builder /build/target/release/softbus-daemon /usr/local/bin/

# 创建目录
RUN mkdir -p /etc/softbus /var/lib/softbus /var/log/softbus && \
    chown -R softbus:softbus /var/lib/softbus /var/log/softbus

# 复制配置
COPY config/docker.toml /etc/softbus/config.toml

# 健康检查
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# 暴露端口
EXPOSE 8888/tcp

# 切换用户
USER softbus

# 启动命令
ENTRYPOINT ["/usr/local/bin/softbus-daemon"]
CMD ["--config", "/etc/softbus/config.toml"]
```

### 2. Docker Compose

```yaml
# docker-compose.yml

version: '3.8'

services:
  softbus:
    build:
      context: .
      dockerfile: Dockerfile
    image: softbus:latest
    container_name: softbus-daemon
    
    # 需要特权访问蓝牙
    privileged: true
    network_mode: host
    
    volumes:
      # 配置
      - ./config/production.toml:/etc/softbus/config.toml:ro
      # 证书
      - ./certs:/etc/softbus/certs:ro
      # 数据持久化
      - softbus-data:/var/lib/softbus
      # 日志
      - softbus-logs:/var/log/softbus
      # DBus socket
      - /var/run/dbus:/var/run/dbus:ro
    
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  softbus-data:
  softbus-logs:
```

### 3. 运行

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 查看状态
docker-compose ps

# 重启
docker-compose restart

# 停止
docker-compose down
```

---

## Kubernetes部署

### 1. Deployment配置

```yaml
# k8s/deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: softbus-daemon
  namespace: softbus
  labels:
    app: softbus
spec:
  replicas: 3
  selector:
    matchLabels:
      app: softbus
  template:
    metadata:
      labels:
        app: softbus
    spec:
      serviceAccountName: softbus
      
      # 节点选择器（需要蓝牙硬件的节点）
      nodeSelector:
        hardware.bluetooth: "true"
      
      containers:
      - name: softbus
        image: softbus:v0.1.0
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: rpc
          containerPort: 8888
          protocol: TCP
        - name: health
          containerPort: 8080
          protocol: TCP
        
        env:
        - name: RUST_LOG
          value: "info"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        
        volumeMounts:
        - name: config
          mountPath: /etc/softbus
          readOnly: true
        - name: certs
          mountPath: /etc/softbus/certs
          readOnly: true
        - name: data
          mountPath: /var/lib/softbus
        - name: dbus
          mountPath: /var/run/dbus
          readOnly: true
        
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        
        livenessProbe:
          httpGet:
            path: /health
            port: health
          initialDelaySeconds: 10
          periodSeconds: 30
        
        readinessProbe:
          httpGet:
            path: /ready
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        
        securityContext:
          capabilities:
            add:
            - NET_RAW
            - NET_ADMIN
          runAsNonRoot: true
          runAsUser: 1000
      
      volumes:
      - name: config
        configMap:
          name: softbus-config
      - name: certs
        secret:
          secretName: softbus-certs
      - name: data
        persistentVolumeClaim:
          claimName: softbus-data
      - name: dbus
        hostPath:
          path: /var/run/dbus
          type: Socket
```

### 2. Service配置

```yaml
# k8s/service.yaml

apiVersion: v1
kind: Service
metadata:
  name: softbus-service
  namespace: softbus
spec:
  type: ClusterIP
  selector:
    app: softbus
  ports:
  - name: rpc
    port: 8888
    targetPort: 8888
    protocol: TCP
  - name: health
    port: 8080
    targetPort: 8080
    protocol: TCP
```

### 3. ConfigMap

```yaml
# k8s/configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: softbus-config
  namespace: softbus
data:
  config.toml: |
    [device]
    name = "K8sPod"
    type = "Server"
    
    [network]
    enabled_adapters = ["mdns", "ethernet"]
    
    [security]
    enable_authentication = true
    enable_encryption = true
    cert_path = "/etc/softbus/certs/tls.crt"
    key_path = "/etc/softbus/certs/tls.key"
    
    [logging]
    level = "info"
    output = "stdout"
```

### 4. 部署

```bash
# 创建命名空间
kubectl create namespace softbus

# 应用配置
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml
kubectl apply -f k8s/deployment.yaml
kubectl apply -f k8s/service.yaml

# 查看状态
kubectl get pods -n softbus
kubectl logs -f -n softbus -l app=softbus

# 扩容
kubectl scale deployment softbus-daemon -n softbus --replicas=5
```

---

## 监控与日志

### 1. Prometheus监控

```yaml
# prometheus/servicemonitor.yaml

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: softbus-metrics
  namespace: softbus
spec:
  selector:
    matchLabels:
      app: softbus
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

**暴露指标**:
```rust
// src/metrics.rs

use prometheus::{
    Registry, Counter, Gauge, Histogram,
    HistogramOpts, Opts,
};

lazy_static! {
    pub static ref REGISTRY: Registry = Registry::new();
    
    pub static ref ACTIVE_CONNECTIONS: Gauge = Gauge::new(
        "softbus_active_connections",
        "Number of active connections"
    ).unwrap();
    
    pub static ref RPC_DURATION: Histogram = Histogram::with_opts(
        HistogramOpts::new(
            "softbus_rpc_duration_seconds",
            "RPC call duration in seconds"
        )
    ).unwrap();
    
    pub static ref BYTES_SENT: Counter = Counter::new(
        "softbus_bytes_sent_total",
        "Total bytes sent"
    ).unwrap();
}

pub fn register_metrics() {
    REGISTRY.register(Box::new(ACTIVE_CONNECTIONS.clone())).unwrap();
    REGISTRY.register(Box::new(RPC_DURATION.clone())).unwrap();
    REGISTRY.register(Box::new(BYTES_SENT.clone())).unwrap();
}
```

### 2. 结构化日志（JSON）

```rust
use tracing_subscriber::fmt;

fn init_logging() {
    fmt()
        .json()  // JSON格式
        .with_current_span(true)
        .with_span_list(true)
        .with_target(true)
        .with_thread_ids(true)
        .init();
}
```

### 3. ELK Stack集成

```yaml
# filebeat/filebeat.yml

filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/softbus/*.log
  json.keys_under_root: true
  json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "softbus-logs-%{+yyyy.MM.dd}"

setup.kibana:
  host: "kibana:5601"
```

---

## 备份与恢复

### 1. 数据备份脚本

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/var/backups/softbus"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 备份配置
tar -czf "$BACKUP_DIR/config_$TIMESTAMP.tar.gz" \
    /etc/softbus/

# 备份数据
tar -czf "$BACKUP_DIR/data_$TIMESTAMP.tar.gz" \
    /var/lib/softbus/

# 备份证书
tar -czf "$BACKUP_DIR/certs_$TIMESTAMP.tar.gz" \
    /etc/softbus/certs/

# 保留最近7天的备份
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: $BACKUP_DIR/*_$TIMESTAMP.tar.gz"
```

### 2. 恢复

```bash
#!/bin/bash
# scripts/restore.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file.tar.gz>"
    exit 1
fi

# 停止服务
sudo systemctl stop softbus

# 恢复数据
sudo tar -xzf "$BACKUP_FILE" -C /

# 恢复权限
sudo chown -R softbus:softbus /var/lib/softbus
sudo chown -R softbus:softbus /etc/softbus

# 重启服务
sudo systemctl start softbus

echo "Restore completed"
```

---

## 故障恢复

### 1. 自动重启

```bash
# 添加到crontab
*/5 * * * * systemctl is-active --quiet softbus || systemctl start softbus
```

### 2. 健康检查端点

```rust
// src/health.rs

use warp::{Filter, Reply};

pub async fn health_check() -> impl Reply {
    let status = HealthStatus {
        status: "ok",
        uptime: get_uptime(),
        connections: get_connection_count(),
    };
    
    warp::reply::json(&status)
}

pub fn health_routes() -> impl Filter<Extract = impl Reply, Error = warp::Rejection> + Clone {
    warp::path("health")
        .and(warp::get())
        .and_then(health_check)
}
```

---

## 性能调优

### 1. 系统参数

```bash
# /etc/sysctl.d/99-softbus.conf

# 增加文件描述符限制
fs.file-max = 2097152

# 网络优化
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# 应用
sudo sysctl -p /etc/sysctl.d/99-softbus.conf
```

### 2. 蓝牙优化

```bash
# /etc/bluetooth/main.conf

[General]
Privacy = device
JustWorksRepairing = never
FastConnectable = true

[LE]
MinConnectionInterval = 7.5
MaxConnectionInterval = 30
ConnectionLatency = 0
ConnectionSupervisionTimeout = 42
```

---

**最后更新**: 2024-11-28
